#  Support for distrib packages.
#
#  For adding a new distrib:
#     - add distrib in get-distrib
#     - implement init-<distrib>-pkg
#     - implement check-<distrib>-pkg
#     - add <pkg>-<distrib>-name routine for specific package name

declare -A SCBI_PKGS

function get-distrib()
{
    echo deb
}

######################################
# cache all installed packages

function init-deb-pkg()
{
    while read ii pkg version dummy; do
        SCBI_PKGS["$pkg"]=$version
    done < <( dpkg-query -l | tail -n+6 | sed 's/:amd64//g' )
}

######################################
# check-deb-pkg should return:
#   3 - package not found
#   2 - package found but not installed
#   1 - package installed but wrong version
#   0 - package installed with proper version

function check-deb-pkg()
{
    local pck=$1
    local version=$(get-version-number $2)

    local inst_ver=${SCBI_PKGS[$pck]}

    if [ -z $inst_ver ]; then
        #  Package is not installed, check if it exists

        dpkg-query -l $pck &> /dev/null

        if [ $? = 0 ]; then
            return 2
        else
            return 3
        fi

    else
        #  Is the installed version ok?

        if [[ $inst_ver > $version ]]; then
            return 0
        else
            return 1
        fi
    fi
}

function get-pkg-name()
{
    local pkg=$1

    fn-exists $pkg-$(get-distrib)-name

    if [[ $? = 0 ]]; then
        echo $pkg-$(get-distrib)-name
    else
        echo $pkg
    fi
}

function check-pkg()
{
    local name_ver=($(echo $1 | tr ":" " "))
    local pkg=${name_ver[0]}
    local version=${name_ver[1]}

    local distname=$(get-pkg-name $pkg)

    check-$(get-distrib)-pkg $pkg $version

    local res=$?

    if [ $res = 3 ]; then
        echo "error: $pkg not found"
        return 1
    elif [ $res = 2 ]; then
        if [ $version == NONE ]; then
            echo "error: $pkg should be installed."
        else
            echo "error: $pkg:$version should be installed."
        fi
        return 1
    elif [ $res = 1 ]; then
        echo "error: $pkg:$version should be installed."
        return 1
    else
        return 0
    fi
}

init-$(get-distrib)-pkg
