
function mingw-update()
{
    PREFIX=$1
    TARGET=$2

    cd $GREPO/mingw-w64 && git checkout master && git svn rebase
}

function mingw-setup()
{
    PREFIX=$1
    TARGET=$2

    case $TARGET in
	*mingw*)
            mkdir -p $TARGET/mingh
            mkdir -p $TARGET/mingrt
            mkdir -p $TARGET/pgcc

            if [ ! -d "src" ]; then
                ln -s $GREPO/mingw-w64 src
            fi
	    ;;
	*)
            echo $TARGET not supported for mingw.
            return 1
	    ;;
    esac
}

function config-mingh()
{
    PREFIX=$1
    TARGET=$2

    cd $BDIR/mingw/$TARGET/mingh &&
    $BDIR/mingw/src/mingw-w64-headers/configure \
	--prefix=$PREFIX/$TARGET --build=$TARGET
}

function config-mingrt()
{
    PREFIX=$1
    TARGET=$2

    cd $BDIR/mingw/$TARGET/mingrt &&
    C_INCLUDE_PATH=$PREFIX/$TARGET/include \
        $BDIR/mingw/src/mingw-w64-crt/configure \
	--prefix=$PREFIX/$TARGET --host=$TARGET --target=$TARGET --build=$HOST
}

function config-pgcc()
{
    PREFIX=$1
    TARGET=$2

    cd $BDIR/mingw/$TARGET/pgcc &&
    CFLAGS="-O1" $BDIR/gnat/src/configure \
	--target=$TARGET --prefix=$PREFIX/$TARGET --build=$HOST \
	--enable-thread=win32 --disable-nls --disable-multilib \
        --disable-libada --disable-sjlj-exceptions --enable-languages=c
}

function mingw-config()
{
    PREFIX=$1
    TARGET=$2

    no-target-env

    config-mingh $PREFIX $TARGET &&
    config-pgcc $PREFIX $TARGET
}

function build-pgcc()
{
    PREFIX=$1
    TARGET=$2

    ilog mingw build pgcc
    # The make will fail, but we install the partial C compiler
    # which is sufficient to build the MingW runtime.
    cd $BDIR/mingw/$TARGET/pgcc
    make -j2
    make -k install

    return 0
}

function build-mingh()
{
    PREFIX=$1
    TARGET=$2

    ilog mingw build mingh
    cd $BDIR/mingw/$TARGET/mingh && make -j6 && make install
}

function build-mingrt()
{
    PREFIX=$1
    TARGET=$2

    ilog mingw build mingrt
    cd $BDIR/mingw/$TARGET/mingrt \
       && C_INCLUDE_PATH=$PREFIX/$TARGET/include make -j4
}

function mingw-build()
{
    PREFIX=$1
    TARGET=$2

    build-mingh $PREFIX $TARGET &&
    build-pgcc  $PREFIX $TARGET &&
    config-mingrt $PREFIX $TARGET &&
    build-mingrt $PREFIX $TARGET
}

function mingw-install()
{
    PREFIX=$1
    TARGET=$2

    cd $BDIR/mingw/$TARGET/mingrt && make install
}
